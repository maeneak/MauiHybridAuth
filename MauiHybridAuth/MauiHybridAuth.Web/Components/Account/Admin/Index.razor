@page "/Admin"
@using MauiHybridAuth.Web.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject RoleManager<IdentityRole> roleManager
@inject UserManager<ApplicationUser> userManager
@inject ISnackbar Snackbar


<PageTitle>Admin</PageTitle>
<AuthorizeView Roles="Admin" Context="authcontext">
    <Authorized>
        <MudTabs>
            <MudTabPanel Text="Users" >
                <MudDataGrid @ref="userGrid" Items="@users" ReadOnly="false" EditMode="DataGridEditMode.Form" EditTrigger="DataGridEditTrigger.OnRowClick"
                CommittedItemChanges="@((ApplicationUser user) => OnUserChanged(user))">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Application Users</MudText>
                        <MudSpacer />
                        <MudIconButton Icon="@Icons.Material.Filled.PersonAdd" />
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="x => x.FirstName" Title="Name" />
                        <PropertyColumn Property="x => x.LastName" Title="Surname" />
                        <PropertyColumn Property="x => x.Email" Title="Email" />
                        <PropertyColumn Property="x => x.UserName" />
                        <PropertyColumn Property="x => x.Roles" Title="User Roles">
                            <EditTemplate> 
                                <MudSelect @bind-SelectedValues="@context.Item.Roles" Converter="RoleConverter" T="IdentityRole"  Label="User Roles" Dense Variant="Variant.Outlined" MultiSelection="true">
                                    @foreach (IdentityRole role in roles)
                                    {
                                        <MudSelectItem T="IdentityRole" Value="@role">@role.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </EditTemplate>
                            <CellTemplate>
                                @if (context.Item.UserRoles != null)
                                {
                                    @foreach (var userrole in context.Item.Roles)
                                    {
                                        <MudChip T="string">@userrole.Name</MudChip>
                                    }
                                }
                            </CellTemplate>
                        </PropertyColumn>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
            <MudTabPanel Text="Roles">
                <MudDataGrid @ref="roleGrid" Items="@roles" EditMode="DataGridEditMode.Form" EditTrigger="DataGridEditTrigger.OnRowClick"
                CommittedItemChanges="@((IdentityRole user) => RoleChanged(user))" ReadOnly="false">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Application Roles</MudText>
                        <MudSpacer />
                        <MudIconButton Icon="@Icons.Material.Filled.AddCircle" OnClick="@(() => roleGrid.SetEditingItemAsync(new IdentityRole()))" />
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="x => x.Name" Title="Name" />
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" OnClick="@(()=>DeleteRole(context.Item))" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
        </MudTabs>
    </Authorized>
    <NotAuthorized>
        <MudText Typo="Typo.h6">You are not authorized to view this page.</MudText>
    </NotAuthorized>
</AuthorizeView>
@code {
    [Inject]
    private IDialogService DialogService { get; set; }
    private List<ApplicationUser> users;
    private List<IdentityRole> roles;
    MudDataGrid<IdentityRole> roleGrid;
    MudDataGrid<ApplicationUser> userGrid;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateRoles(false);
            await UpdateUsers(false);

            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    async Task UpdateRoles(bool update = true)
    {
        roles = await roleManager.Roles.ToListAsync();
        if (update) StateHasChanged();

    }

    async Task UpdateUsers(bool update = true)
    {
        users = await userManager.Users.Include(inc => inc.UserRoles).ToListAsync();

        foreach (var user in users)
        {
            user.Roles = user.UserRoles
                .Select(userRole => roles.First(role => role.Id == userRole.RoleId))
                .ToList();
        }

        if (update) StateHasChanged();
    }

    async Task SaveUserRoles(ApplicationUser user)
    {
        var newroles = (from u in user.Roles where u.Name != null && !user.UserRoles.Select(ur=>ur.RoleId).Contains(u.Id) select u.Name);
        if(newroles.Any())
        {
            await userManager.AddToRolesAsync(user, newroles);
        }
        else
        {
            var allroles = from r in roles where r.Name != null select r.Name;
            await userManager.RemoveFromRolesAsync(user, allroles);
        }
        await UpdateUsers();
    }

    async void RoleChanged(IdentityRole role)
    {
        if (await roleManager.RoleExistsAsync(role.Name)) {
            Snackbar.Add("Role already exists.");
        }
        else {
            IdentityResult result = await roleManager.CreateAsync(role);
            await UpdateRoles();        
        }
    }
    async void DeleteRole(IdentityRole role)
    {
        bool? confirm = await DialogService.ShowMessageBox("Confirm Delete", $"Delete the role '{role.Name}'?", yesText: "Delete", cancelText: "Cancel");
        if (confirm != null && confirm == true)
        {
            IdentityResult result = await roleManager.DeleteAsync(role);
            await UpdateRoles();
        }
    }

    async void OnStartEditUser(ApplicationUser user)
    {
        await UpdateRoles(false);
        await UpdateUsers(false);
        StateHasChanged();
    }

    async void OnUserChanged(ApplicationUser user)
    {
        IdentityResult result = await userManager.UpdateAsync(user);
        await SaveUserRoles(user);
        await UpdateUsers();
    }

}